id: com.genymobile.scrcpy

runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk

command: scrcpy.sh

add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .

cleanup:
  - /share/bash-completion
  - /share/zsh-completion
cleanup-commands:
  - mv -f /app/share/icons/hicolor/256x256/apps/scrcpy.png /app/share/icons/hicolor/256x256/apps/com.genymobile.scrcpy.png
  - mv -f /app/share/applications/scrcpy.desktop /app/share/applications/com.genymobile.scrcpy.desktop
  - rm -f /app/share/applications/scrcpy-console.desktop
  - sed -Ei 's#(Exec=).+#\1/app/bin/scrcpy.sh#' /app/share/applications/com.genymobile.scrcpy.desktop
  - sed -Ei 's#(Icon=).+#\1com.genymobile.scrcpy#' /app/share/applications/com.genymobile.scrcpy.desktop

finish-args:
  - --device=all
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11
  - --persist=.android

modules:
  - shared-modules/libusb/libusb.json
  - name: adb
    buildsystem: simple
    build-commands:
      - install -D adb /app/bin/adb
    sources:
      - type: archive
        url: https://dl.google.com/android/repository/platform-tools_r35.0.2-linux.zip
        sha256: acfdcccb123a8718c46c46c059b2f621140194e5ec1ac9d81715be3d6ab6cd0a
        x-checker-data:
          type: anitya
          project-id: 226905
          url-template: https://dl.google.com/android/repository/platform-tools_r$version-linux.zip
  - name: scrcpy
    buildsystem: meson
    config-opts:
      - --buildtype=release
      - -Db_lto=true
      - -Dprebuilt_server=scrcpy-server
      - --strip
    sources:
      - type: archive
        url: https://github.com/Genymobile/scrcpy/archive/refs/tags/v2.7.tar.gz
        sha256: 3ceea215f6eccb59535f68a16db6db2b05a8a1c91bdcb4a6e222d3093a9daf8c
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Genymobile/scrcpy/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: '"https://github.com/Genymobile/scrcpy/archive/refs/tags/v" +
            $version + ".tar.gz"'
      - type: file
        url: https://github.com/Genymobile/scrcpy/releases/download/v2.7/scrcpy-server-v2.7
        sha256: a23c5659f36c260f105c022d27bcb3eafffa26070e7baa9eda66d01377a1adba
        dest-filename: scrcpy-server
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Genymobile/scrcpy/releases/latest
          version-query: .tag_name | sub("v"; "")
          url-query: '"https://github.com/Genymobile/scrcpy/releases/download/v" +
            $version + "/scrcpy-server-v" + $version'
  - name: scrcpy-wrapper
    buildsystem: simple
    build-commands:
      - install -D scrcpy.sh /app/bin/scrcpy.sh
    sources:
      - type: file
        path: scrcpy.sh
  - name: scrcpy-metadata
    buildsystem: simple
    build-commands:
      - install -D com.genymobile.scrcpy.metainfo.xml /app/share/metainfo/com.genymobile.scrcpy.metainfo.xml
    sources:
      - type: file
        path: com.genymobile.scrcpy.metainfo.xml
